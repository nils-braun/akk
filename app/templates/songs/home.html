{% extends "base.html" %}
{% block content_id %}content-songlist{% endblock %}
{% block content %}
    <script type="application/javascript">
        var currentPage = 0;
        var loading = false;

        function make_search_query(query, page) {
            if(loading) {
                return;
            }
            if(typeof page === "undefined") {
                $("#song-list").find("tbody").html("");
                make_search_query(query, 0);
            } else {
                loading = true;
                $.get("{{ url_for("songs.search") }}", {query: query, page: page}, function (data) {
                    if (data.length != 0) {
                        $("#song-list").find("tbody").append(data);
                        addBindings();
                        currentPage += 1;
                        loading = false;
                    }
                });
            }
        }

        function add_reset_binding() {
            $("#search_form").on("click", "input[type=reset]", function () {
                window.location = "{{ url_for("songs.home") }}";
            });
        }

        function add_audio_binding() {
            var audio_to_play = undefined;

            function is_new_source() {
                return audio_to_play == undefined;
            }

            function start_playing(audio_file_name, play_control) {
                audio_to_play = new Audio(audio_file_name);
                audio_to_play.play();
                $(play_control).addClass("playing");
            }

            function stop_playing() {
                if (audio_to_play != undefined) {
                    audio_to_play.pause();
                }
                $("#content-songlist").find(".player-controls").removeClass("playing");
            }

            $("#content-songlist").on("click", ".player-controls", function () {
                var audio_file_name = "/static/data/" + $(this).attr("data-path");

                if (is_new_source()) {
                    stop_playing();
                    start_playing(audio_file_name, this);
                } else {
                    if (audio_to_play.paused) {
                        start_playing(audio_file_name, this);
                    } else {
                        stop_playing(this);
                    }
                }
            })
        }

        function add_endless_scroll_binding() {
            $("#content-wrapper").scroll(function (e) {
                var elem = $(e.currentTarget);
                if (elem[0].scrollHeight - elem.scrollTop() < elem.outerHeight() + 100) {
                    make_search_query("{{ query }}", currentPage);
                }
            })
        }

        $(document).ready(function() {
            make_search_query("{{ query }}");
            add_reset_binding();
            add_audio_binding();
            add_endless_scroll_binding();
        });
    </script>

    <form class="form" id="search_form">
        <table>
            <tbody>
            <tr>
                <td>
                    <input title="" type="text" id="query" name="query" class="input text completion completion-all" value="{{ query }}">
                </td>
                <td width="200px">
                    <input type="submit" value="Search" class="button">
                </td>
                <td width="200px">
                    <input type="reset" value="Clear" class="button">
                </td>
            </tr>
            </tbody>
        </table>
    </form>

    <div id="control-view">
        <a href="{{ url_for('songs.create_song') }}">Add Song</a>
        <a href="{{ url_for('songs.delete_artist') }}">Delete Artist</a>
        <a href="{{ url_for('songs.delete_dance') }}">Delete Dance</a>
    </div>

    <table id="song-list">
        <thead>
            <tr>
                <td width="50px"></td>
                <td width="30%">Song Title</td>
                <td width="30%">Artist Name</td>
                <td width="20%">Dance Name</td>
                <td width="400px">Rating</td>
                <td width="400px">User Rating</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
{% endblock %}